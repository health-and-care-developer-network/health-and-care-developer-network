<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Apr 2, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Auto generated" />
    <meta name="Date-Revision-yyyymmdd" content="20130402" />
    <meta http-equiv="Content-Language" content="en" />
    <title>ITK API and Reference Implementation - 
      ITK requirements and Reference Implementation Cross-reference</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

                          
        
<link rel="stylesheet" href="css/itk-mini-site.css"></link>
                      
        
<link rel="stylesheet" type="text/css" href="js/prettify.css"></link>
                      
        
<script src="js/prettify.js" type="text/javascript"></script>
                      
        
<script src="js/itk-api-site.js" type="text/javascript"></script>
          
            </head>
        <body class="topBarEnabled">
          
                        
                    
                

    <div id="topbar" class="navbar navbar-fixed-top navbar-inverse">
      <div class="navbar-inner">
                                  <div class="container"><div class="nav-collapse">
            
                
                                                                                <a class="brand" href="index.html"  title="IRK">

                                
                                                                                                                    <img src="images/itk-small.gif" alt="IRK" />
                
                </a>
                    
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Scenarios <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="scenarios-overview.html"  title="Scenarios Overview">Scenarios Overview</a>
</li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Synchronous"  title="Synchronous">Synchronous</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="sync-query-sender.html"  title="Spine Mini-Services (client)">Spine Mini-Services (client)</a>
</li>
                                  <li>      <a href="sync-query-receiver.html"  title="Spine Mini-Services (provider)">Spine Mini-Services (provider)</a>
</li>
                                  <li>      <a href="simple-sync-fireandforget.html"  title="ADT Admit Patient (P/H)">ADT Admit Patient (P/H)</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Simple Asynchronous"  title="Simple Asynchronous">Simple Asynchronous</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="simple-async-adt-query.html"  title="ADT Query patient (XML)">ADT Query patient (XML)</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Routed Message"  title="Routed Message">Routed Message</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="routed-cda-document-repo.html"  title="Routed CDA (document repository)">Routed CDA (document repository)</a>
</li>
                                  <li>      <a href="routed-cda-with-business-ack.html"  title="Routed CDA (with business Ack)">Routed CDA (with business Ack)</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Reports <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li class="dropdown-submenu">
                                      <a href="project-info.html"  title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="index.html"  title="About">About</a>
</li>
                                  <li>      <a href="team-list.html"  title="Project Team">Project Team</a>
</li>
                                  <li>      <a href="issue-tracking.html"  title="Issue Tracking">Issue Tracking</a>
</li>
                                  <li>      <a href="modules.html"  title="Project Modules">Project Modules</a>
</li>
                                  <li>      <a href="license.html"  title="Project License">Project License</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="apidocs/index.html"  title="JavaDocs">JavaDocs</a>
</li>
                                  <li>      <a href="xref/index.html"  title="Source Xref">Source Xref</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="../itk-api/index.html"  title="ITK API">ITK API</a>
</li>
                  
                      <li>      <a href="../itk-ri/index.html"  title="ITK Java Reference Implementation">ITK Java Reference Implementation</a>
</li>
                  
                      <li>      <a href="../itk-samples/index.html"  title="ITK Samples project">ITK Samples project</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="requirements-cross-ref.html"  title="ITK Requirement traceability">ITK Requirement traceability</a>
</li>
                  
                      <li>      <a href="../itk-api/apidocs/index.html"  title="Javadocs (API only)">Javadocs (API only)</a>
</li>
                  
                      <li>      <a href="apidocs/index.html"  title="Javadocs (API + RI + Samples)">Javadocs (API + RI + Samples)</a>
</li>
                  
                      <li>      <a href="xref/index.html"  title="Java source cross-reference">Java source cross-reference</a>
</li>
                  
                      <li>      <a href="../itk-samples/downloads.html"  title="Downloads">Downloads</a>
</li>
                  
                      <li>      <a href="../itk-samples/index.html"  title="Install Guide">Install Guide</a>
</li>
                  
                      <li>      <a href="docs/ITK Basic Workshop v0.1 - Webex.pdf"  target="_blank" title="ITK Basic Workshop - Webex Slides">ITK Basic Workshop - Webex Slides</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Disclaimer <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="disclaimer.html"  title="Disclaimer">Disclaimer</a>
</li>
                          </ul>
      </li>
                  </ul>
          
          
                                                              
                               <ul class="nav pull-right">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">External Links <b class="caret"></b></a>
                <ul class="dropdown-menu">
                      <li>      <a href="http://services.developer.nhs.uk/itk-samples/"  title="ITK RI (Running samples)">ITK RI (Running samples)</a>
</li>
      <li>      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop"  title="CFH ITK home page">CFH ITK home page</a>
</li>
      <li>      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop/fund"  title="ISCF">ISCF</a>
</li>
      <li>      <a href="http://www.uktcregistration.nss.cfh.nhs.uk/trud3/user/guest/group/0/pack/21"  title="ITK @ TRUD">ITK @ TRUD</a>
</li>
      <li>      <a href="http://www.networks.nhs.uk/nhs-networks/interoperability-toolkit-itk"  title="ITK @ NHS Networks">ITK @ NHS Networks</a>
</li>
      <li>      <a href="http://www.linkedin.com/groups/NHS-Interoperability-Toolkit-3831338"  title="ITK @ LinkedIn">ITK @ LinkedIn</a>
</li>
                  </ul>
              </li>
            </ul>
          
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>ITK API and Reference Implementation mini-site</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
            
                
                    
      
                            </ul>
      </div>

      
                
        <div id="bodyColumn" >
                                  
            
   
      <div class="section"><h2>Spine Mini-Services Client - Get Patient Details by NHSNumber<a name="Spine_Mini-Services_Client_-_Get_Patient_Details_by_NHSNumber"></a></h2>
          
        <ul class="nav nav-tabs tab-control">
          <li class="active"><a href="#overview">Overview</a></li>
          <li><a href="#sender">SMS Client</a></li>
          <li><a href="#receiver">SMS Provider</a></li>
          <li><a href="#request">Request</a></li>
          <li><a href="#response">Response</a></li>
        </ul>       
	       <div class="row-fluid" style="min-height: 480px;">
    <div class="span5">
       
       <div class="clickablemapview">
          <p class="tab-title">Black box view</p>
          <img src="images/smsp - black-box view.jpg" usemap="#bbviewmap" alt="" />
           <map name="bbviewmap">
              <area shape="rect" coords="11,8,102,57" title="SMS Client" href="#sender"></area>
              <area shape="rect" coords="348,8,438,57" title="SMS Provider" href="#receiver"></area>
              <area shape="rect" coords="125,80,325,110" title="Get Patient Details By NHSNumber Request" href="#request"></area>
              <area shape="rect" coords="125,160,325,180" title="Get Patient Details By NHSNumber Response" href="#response"></area>
           </map>
       </div>    
    </div>
    <div class="span7">
        <div class="tab-content">
  <div class="tab-pane active" id="overview">
        <p class="tab-title">Overview</p>
        <p>In this scenario a client application is indirectly querying Spine PDS to obtain demographic information held for the provided NHSNumber. From a business perspective this is typically used to check (and/or potentially update) the locally held demographic details about the patient from the national Patient Demographic Service.</p>
        <p>The following describes the logic required to invoke the ITK <tt>urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0</tt> service.</p>
        <p>From a black-box perspective the invocation of a Spine Mini-Service Provider web service interface is fairly trivial. The service requestor simply sends the appropriate ITK request message and receives the response synchronously. Likewise any exceptions will be returned as synchronous SOAP Faults.</p>
  </div>
  <div class="tab-pane" id="sender">
        <p class="tab-title">Spine Mini-Services - Client</p>
        <p>As the SMS client already has the pertient patient's NHSNumber in their local data store the query to get the latest demographics via the SMS Provider is relatively straightforward. The SMS Client builds the Get Patient Details By NHSNumber Request query message providing the patient's NHSNumber and Date of Birth.</p>
  </div>
  <div class="tab-pane" id="receiver">
        <p class="tab-title">Spine Mini-Services - Provider</p>
        <p>The SMS Provider is a unique component in ITK - providing a bridge between the Spine PDS interfaces and Spine Mini Service Clients. In a real deployment, the SMSP would receieve the ITK Get Patient Details By NHSNumber Request, make one or more queries to Spine services the results of which are used construct the appropriate ITK Get Patient Details By NHSNumber Response.</p>
        <p>In the samples application the SMSP is emulated via a simple XSLT that creates a response from the request</p>
  </div>
  <div class="tab-pane" id="request">
      <p class="tab-title">Get Patient Details By NHSNumber Request
      <a href="samples/GetPatientDetailsByNHSNumberRequest.xml" target="_blank" type="text/xml">(Get example)</a></p>      
      <div class="source"><pre class="prettyprint linenums">&lt;soap:Envelope xmlns:itk=&quot;urn:nhs-itk:ns:201005&quot; ...&gt;
  &lt;soap:Header&gt;
    ...
    &lt;wsa:To&gt;http://www.example.com/sync&lt;/wsa:To&gt;
    &lt;wsa:From&gt;&lt;wsa:Address&gt;http://127.0.0.1:4000/syncsoap&lt;/wsa:Address&gt;&lt;/wsa:From&gt;
  &lt;/soap:Header&gt;
  &lt;soap:Body&gt;
    &lt;itk:DistributionEnvelope&gt;
      &lt;itk:header service=&quot;urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0&quot; ...&gt;  ... &lt;/itk:header&gt;
      &lt;itk:payloads count=&quot;1&quot;&gt;
        &lt;itk:payload id=&quot;uuid_D1F95107-42FD-4AB5-936F-A3D2A489DD61&quot;&gt;
          &lt;getPatientDetailsByNHSNumberRequest-v1-0 xmlns=&quot;urn:hl7-org:v3&quot; ...&gt;
                    ...
          &lt;/getPatientDetailsByNHSNumberRequest-v1-0&gt;
        &lt;/itk:payload&gt;
      &lt;/itk:payloads&gt;
    &lt;/itk:DistributionEnvelope&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</pre></div>
  </div>
  <div class="tab-pane" id="response">
      <p class="tab-title">Get Patient Details By NHSNumber Response
      <a href="samples/GetPatientDetailsByNHSNumberResponse.xml" target="_blank" type="text/xml">(Get example)</a></p>      
<div class="source"><pre class="prettyprint linenums">&lt;soap:Envelope xmlns:wsa=&quot;http://www.w3.org/2005/08/addressing&quot;...&gt;
  &lt;soap:Header&gt;
	  ...
    &lt;wsa:Action&gt;urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0Response&lt;/wsa:Action&gt;
	  ...
  &lt;/soap:Header&gt;
  &lt;soap:Body&gt;
    &lt;itk:DistributionEnvelope&gt;
      &lt;itk:header service=&quot;urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0Response&quot; ...&gt; ... &lt;/itk:header&gt;
      &lt;itk:payloads count=&quot;1&quot;&gt;
        &lt;itk:payload ...&gt;
          &lt;getPatientDetailsResponse-v1-0 xmlns=&quot;urn:hl7-org:v3&quot; ...&gt;
	                ...
          &lt;/getPatientDetailsResponse-v1-0&gt;
        &lt;/itk:payload&gt;
      &lt;/itk:payloads&gt;
    &lt;/itk:DistributionEnvelope&gt;
  &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</pre></div>      
  </div>
</div>
    </div>
</div>	     
	  </div>
	  
	  <div class="section"><h2>Walkthrough<a name="Walkthrough"></a></h2>
	   <p>The following diagram shows how the sample application 
          <tt>uk.nhs.interoperability.client.samples.smsp.SpineMiniServicesClient</tt> from the <a href="../itk-samples/index.html">samples project</a> uses the reference implementation to make a call to a Spine Mini-Service Provider.</p>
	       <img src="images/smsp - client.jpg" usemap="#clientseqmap" width="1300" alt="" />
	       <map name="clientseqmap">
            <area shape="rect" coords="75,170,125,220" title="Step 1" href="#step-1"></area>
            <area shape="rect" coords="290,240,340,290" title="Step 2" href="#step-2"></area>
            <area shape="rect" coords="350,350,410,410" title="Step 3" href="#step-3"></area>
            <area shape="rect" coords="675,460,730,515" title="Step 4" href="#step-4"></area>
         </map>
         <div id="step-1"></div>
	       <div class="row-fluid horizontal-spacer">
	           <div class="span6">
	               <p class="step-heading">Step <span class="label label-important label-large">1</span></p>
	               <p>In order to invoke the Spine mini-service the application layer first needs to collect and populate the query parameters. The sample application does this from a simple web form (see <a class="externalLink" href="http://services.developer.nhs.uk/itk-samples/GetPatientDetailsByNHSNumber.html">http://services.developer.nhs.uk/itk-samples/GetPatientDetailsByNHSNumber.html</a>) however how real world applications obtain the query parameters is outside the scope of the API and reference implementation.</p>
	               <p>Once the application has constructed the appropriate query object it needs to be handed over to the transport layers for the actual technical invocation of the service.</p>
	               <p>The actual specific on-the-wire format of the query message is not the responsibility of the transport layers to determine or manage. The <tt>request.serialise()</tt> method at line 6 populates the payload for the ITK invocation - in this case a <tt>getPatientDetailsByNHSNumber-v1-0</tt> XML message with the appropriate parameters set.</p>
	               <p>It is an application layer responsibility to set the audit identity, to and from address details, profileId and business payload id (line 10). Many of these details are omitted here for clarity - for reference the <a href="apidocs/uk/nhs/interoperability/infrastructure/ITKMessageProperties.html">ITKMessageProperties</a> provides getters and setters to allow the message meta-data and addressing information to be passed between the application and transport layers.</p>
	               <p>Once the properties have been associated with the payload (line 14) the distribution and transport layers are invoked via the <a href="apidocs/uk/nhs/interoperability/source/ITKMessageSender.html#sendSyncuk.nhs.interoperability.payload.ITKMessage">ITKMessageSender sendSync API call</a>.</p>
	               <p>The full <a href="xref/uk/nhs/interoperability/client/samples/smsp/SpineMiniServicesClient.html#118">source code for this method can be seen here</a>.</p>
	              
	           </div>
	           <div class="span6">
	           <div id="listing-1"></div>
           <div class="source"><pre class="prettyprint linenums">
public GetPatientDetailsByNHSNumberResponse getPatientDetailsByNHSNumber(GetPatientDetailsByNHSNumberRequest request){

   GetPatientDetailsByNHSNumberResponse response = null;
   
   ITKMessage msg = new SimpleMessage();
   msg.setBusinessPayload(request.serialise());
   
   // Build the message properties.
   ITKMessageProperties mp = new ITKMessagePropertiesImpl();
   mp.setAuditIdentity(AUDITID);
   ... //Other properties also set

   // Add the properties to the message
   msg.setMessageProperties(mp);
   
   // Create the sender
   ITKMessageSender sender = new ITKMessageSenderImpl();
   try {
       ITKMessage resp = sender.sendSync(msg);
       response = new GetPatientDetailsByNHSNumberResponse(resp);        
   } catch (ITKMessagingException e) {
       Logger.error(&quot;Error Sending ITK Message&quot;,e);
   }
   return response;
}          
           </pre></div>
           <p class="caption"><b>Listing 1</b> building a business message and invoking the ITK transport layers</p>
           </div>
	       </div>
	       
	       <div id="step-2"></div>
	       <div class="row-fluid horizontal-spacer">
             <div class="span6">
                 <div id="listing-2"></div>
                 <div class="source"><pre class="prettyprint linenums">public ITKMessage sendSync(ITKMessage request) throws ITKMessagingException {

  // Get the ITKService from the DirectoryOfService
  String serviceId = request.getMessageProperties().getServiceId();
  ITKService service = directoryOfServices.getService(serviceId);      
  ... //Validate that the service is configured and supports sync

  //Determine the physical transport route
  ITKTransportRoute route = getRoute(request);

  //Get the transport specific ITKSender implementation 
  ITKSender sender = getSender(route);

  //Add the necessary ITK wrappers, base64 encode where required
  ITKMessage message = buildMessage(request, route, service);
  
  //Send the message
  ITKMessage response = sender.sendSync(route, message);
  
  //Deserialise and unwrap
  ITKMessage simpleResponse = buildResponse(response);  
  return simpleResponse;
}
                 </pre></div>
                 <p class="caption"><b>Listing 2</b> determining transport, destination and building ITK wrappers</p>
             </div>
             <div class="span6">
                 <p class="step-heading">Step <span class="label label-important label-large">2</span></p>
                 <p class="pre-spaced alert alert-info"><b>Note</b> this step and the majority of the subsequent steps are common to all synchronous invocations via the Reference Implementation.</p>
                 <p>The application request payload is passed into the framework via the <tt>ITKMessage</tt>. In order to succesfully call the service provider we need to resolve the service properties, obtain the route appropriate to the service provider, add the necessary wrappers and call the appropriate transport specific implementation classess.</p>
                 <p>The resolution of the route (line 9)  is shown in more detail in Step 3 (<a href="#listing-3a">listing 3a</a> below). Having obtained the route we then get a reference to the transport specific <tt>ITKSender</tt> (line 12). <b>Note</b> the 0.1 release of the reference implementation only contains an implementaiton for <a href="apidocs/uk/nhs/interoperability/transport/WS/ITKSenderWSImpl.html">HTTP/SOAP Web services</a>. The reference implementation could be be extended in the future to support DTS, TMS and other transports as specified by ITK.</p>
                 <p>The details of building the ITK Distribution Envelope and on-the-wire encoding (line 15) are shown in detail in <a href="#listing-3b">listing 3b</a> below. Once the appropriate ITK message has been created the transport specific <tt>ITKSender</tt> is used to actual send the message (line 18). For this scenario the HTTP/WS invocation is shown in detail in <a href="#step-4">Step 4</a> below</p>
                 <p>Once the transport layers have returned with the synchronous response this is unwrapped / deserialised via the <a href="xref/uk/nhs/interoperability/source/ITKMessageSenderImpl.html#258">buildResponse(response)</a> method (line 21).</p>
             </div>
         </div>
         
         <div id="step-3"></div>
         <div class="row-fluid  horizontal-spacer">
             <div class="span6">
                 <p class="step-heading">Step <span class="label label-important label-large">3</span></p>
                 <p>Listing 3a shows the logic for resolving the <tt>ITKTransportRoute</tt>, whilst Listing 3b shows the simple logic used to determine whether or not the payload should be wrapped in an ITK Distribution Envelope and base64 encoded.</p>
                 <p>The <tt>ITKTransportRoute</tt> may have already been pre-resolved from the application layer (listing 3, line 9) in which case we do not need to look it up. The pre-resolved route may have been determined via application layer configuration or because the application has maintained the transport return address details from a corresponding request in an <a href="scenarios-overview.html#Simple_Asynchronous">asynchronous invocation</a>.</p>
                 <p>In this synchronous invocation scenario the logical destination address provided by the application layer will need to be resolved to an HTTP URL for the web service invocation. This is achieved via the call to the <a href="apidocs/uk/nhs/interoperability/capabilities/DirectoryOfServices.html">DirectoryOfService</a> on line 15. In the reference implementation the <i>directory</i> is a simple properties file wrapped by some simple logic - see <a href="xref/uk/nhs/interoperability/service/ITKSimpleDOS.html#80">ITKSimpleDOS</a>. </p>
                 <p>The <tt>DirectoryOfService</tt> is responsible for returning a fully populated <a href="apidocs/uk/nhs/interoperability/transport/ITKTransportRoute.html">ITKTransportRoute</a> which contains details of the under lying transport type, the <i>physical</i> destination address and whether or not a distribution envelope is required.</p>
                 <p class="pre-spaced">Listing 3b shows the logic for building the transport independent ITK message.</p>
                 <p>Line 4 determines whether a distribution envelope is required. If the message needs to be wrapped by a Distribution Envelope a new ITKMessage including the DistributionEnvelope is built via the <a href="xref/uk/nhs/interoperability/payload/DEWrappedMessage.html#91">DEWrappedMessage</a> constructor (line 12). </p>
                 <p>Prior to building the complete Distribution Envelope wrapped message is may be that the business payload needs to be base64 encoded. Logically this is a property of the <tt>ITKService</tt> (determined via configuration), however in terms of the current ITK Specifications this is only required for HL7v2 messages exchanged in <i>pipe and hat (|^)</i> format. In this <tt>getPatientDetailsByNHSNumber</tt> scenario the business payload message is XML based and no base64 encoding is required.</p>
             </div>
             <div class="span6">
                 <div id="listing-3a"></div>
                 <div class="source"><pre class="prettyprint linenums">private ITKTransportRoute getRoute(ITKMessage message) throws ITKMessagingException {

  String serviceId = message.getMessageProperties().getServiceId();
  /*
   * Has the transport route already been resolved?
   * E.g. route may already be set on a response
   */
  ITKTransportRoute route = message.getPreresolvedRoute();
  ITKAddress toAddress = message.getMessageProperties().getToAddress();
  
  //If the route has not been pre-resolved look it up
  if (route == null) {
    // Resolve Destination Service in terms of a TransportRoute
    route = directoryOfServices.resolveDestination(serviceId,toAddress);      
  } 
  //Throw an exception if we cannot resolve the route  
  if (route == null) {
    throw new ITKMessagingException(&quot;No route found ...&quot;);
  }     
  return route;
}</pre></div>
                <p class="caption"><b>Listing 3a</b> resolving the transport via the directory of services</p>
                <br />
                <div id="listing-3b"></div>
                <div class="source"><pre class="prettyprint linenums">private ITKMessage buildMessage(ITKMessage message, ITKTransportRoute route, ITKService service) {

  // Does the message need a wrapper?
  if (route.getWrapperType().equals(ITKTransportRoute.DISTRIBUTION_ENVELOPE)) {
  
    //Do we need to base64 encode the business payload?
    if (service.isBase64()) {
      //Use standard javax.xml.bind libraries to base64 encode
      String b64DocText = DatatypeConverter.printBase64Binary(message.getBusinessPayload().getBytes());
      message.setBusinessPayload(b64DocText);
    }
    return new DEWrappedMessage(service, message, DEWrappedMessage.DE_ADDRESSED); 
  } else {
    //Send the business payload as is
    return request;
  } 
}</pre></div>
                <p class="caption"><b>Listing 3b</b> adding the ITK Distribution Envelope</p>
             </div>
         </div>
         
         <div id="step-4"></div>
         <div class="row-fluid horizontal-spacer">             
             <div class="span6">    
                 <div id="listing-4"></div>             
                 <div class="source"><pre class="prettyprint linenums">public ITKMessage sendSync(ITKTransportRoute destination, ITKMessage request) throws ITKMessagingException {
      
 // Add the soap wrappers
WSSOAPMessageImpl msg = new WSSOAPMessageImpl(destination, request, ...);
...
//Obtain the on-the-wire message
String soapPayload = msg.getFullPayload();

try {   
   //Send the on-the-wire message via HTTP
   Document responseDoc = transportSend(destination, soapPayload);   
   ...
   // Extract the SOAP Body Content via XPath
   Document businessPayloadDoc = DomUtils.createDocumentFromNode((Node)XPaths.SOAP_BODY_CONTENT_XPATH.evaluate(responseDoc...));
   // Get string representation of the response business payload
   String responseStr = DomUtils.serialiseToXML(businessPayloadDoc);      
   //Construct the appropriate object for the application layer
   return new SimpleMessage(responseStr);
 } catch (...) {  ... }    
}</pre></div>
                 <p class="caption"><b>Listing 4</b> making a web-service call and unwrapping the response</p>
             </div>
             <div class="span6">
                 <p class="step-heading">Step <span class="label label-important label-large">4</span></p>
                 <p>Listing 4 shows the code within the <a href="xref/uk/nhs/interoperability/transport/WS/ITKSenderWSImpl.html">ITKSenderWSImpl</a> which is responsible for adding the SOAP and WS-Addressing wrappers, for invoking the appropriate web-service endpoint as determined by the <tt>ITKTransportRoute</tt> and managing HTTP and SOAPFaults or other exceptions arising from the invocation.</p>
                 <p>In <a href="#step-3">Step 3</a> we created a transport independent ITK message. The logic of this class is specific to ITK Web services and requires that we add SOAP Wrappers including the appropate ws-addressing elements as per the ITK Specifications (line 4).</p>
                 <p>The call on line 7 to obtain the full payload <a href="xref/uk/nhs/interoperability/transport/WS/WSSOAPMessageImpl.html#379">invokes an XSLT transform</a> that creates the complete on-the-wire SOAP message with the ITK Distribution Envelope wrapped <tt>getPatientDetailsByNHSNumber</tt> within the SOAP body.</p>
                 <p>The web service is actually invoked via the <a href="xref/uk/nhs/interoperability/transport/WS/ITKSenderWSImpl.html#236">transportSend(destination, soapPayload)</a> method call.</p>
                 <p>As this is a synchronous call there is no information in the response message SOAP header pertinent to the client so we directly extract the response payload (line 14) which is then passed back up the call stack via the returned <tt>SimpleMessage</tt> (line 18).</p>
             </div>
         </div>
	  </div>
   

                  </div>
          </div>

    <hr/>

    <footer>
            <div class="container">
              <div class="row span12">All content is available under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/" title="Open Government Licence">Open Government Licence</a>, except where otherwise stated<br/>
                                  All example source code is available under <a href="http://www.apache.org/licenses/LICENSE-2.0.html" title="Apache 2.0 License">Apache 2.0</a>, except where otherwise stated      
                    
                  <li id="publishDate" class="pull-right">Last Published: 2013-04-02</li> 
              <li id="projectVersion" class="pull-right">Version: 0.1-SNAPSHOT</li>
            </div>

        
                <p id="poweredBy" class="pull-right">
                                                                                                                      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop" title="ITK" class="builtBy">
        <img class="builtBy"  alt="ITK" src="images/itk-logo-2.png"    />
      </a>
                  </p>
        
                </div>
    </footer>
  </body>
</html>
