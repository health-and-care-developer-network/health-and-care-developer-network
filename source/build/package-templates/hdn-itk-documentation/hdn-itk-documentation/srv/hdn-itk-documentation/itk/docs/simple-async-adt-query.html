<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at Mar 6, 2013
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="author" content="Nick Jones" />
    <meta name="Date-Revision-yyyymmdd" content="20130306" />
    <meta http-equiv="Content-Language" content="en" />
    <title>ITK API and Reference Implementation - 
    ITK API and reference implementation</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

                          
        
<link rel="stylesheet" href="css/itk-mini-site.css"></link>
                      
        
<link rel="stylesheet" type="text/css" href="js/prettify.css"></link>
                      
        
<script src="js/prettify.js" type="text/javascript"></script>
                      
        
<script src="js/itk-api-site.js" type="text/javascript"></script>
          
            </head>
        <body class="topBarEnabled">
          
                        
                    
                

    <div id="topbar" class="navbar navbar-fixed-top navbar-inverse">
      <div class="navbar-inner">
                                  <div class="container"><div class="nav-collapse">
            
                
                                                                                <a class="brand" href="index.html"  title="IRK">

                                
                                                                                                                    <img src="images/itk-small.gif" alt="IRK" />
                
                </a>
                    
                                <ul class="nav">
                          <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Scenarios <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="scenarios-overview.html"  title="Scenarios Overview">Scenarios Overview</a>
</li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Synchronous"  title="Synchronous">Synchronous</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="sync-query-sender.html"  title="Spine Mini-Services (client)">Spine Mini-Services (client)</a>
</li>
                                  <li>      <a href="sync-query-receiver.html"  title="Spine Mini-Services (provider)">Spine Mini-Services (provider)</a>
</li>
                                  <li>      <a href="simple-sync-fireandforget.html"  title="ADT Admit Patient (P/H)">ADT Admit Patient (P/H)</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Simple Asynchronous"  title="Simple Asynchronous">Simple Asynchronous</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="simple-async-adt-query.html"  title="ADT Query patient (XML)">ADT Query patient (XML)</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="scenarios-overview.html#Routed Message"  title="Routed Message">Routed Message</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="routed-cda-document-repo.html"  title="Routed CDA (document repository)">Routed CDA (document repository)</a>
</li>
                                  <li>      <a href="routed-cda-with-business-ack.html"  title="Routed CDA (with business Ack)">Routed CDA (with business Ack)</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Project Reports <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li class="dropdown-submenu">
                                      <a href="project-info.html"  title="Project Information">Project Information</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="index.html"  title="About">About</a>
</li>
                                  <li>      <a href="team-list.html"  title="Project Team">Project Team</a>
</li>
                                  <li>      <a href="issue-tracking.html"  title="Issue Tracking">Issue Tracking</a>
</li>
                                  <li>      <a href="modules.html"  title="Project Modules">Project Modules</a>
</li>
                                  <li>      <a href="license.html"  title="Project License">Project License</a>
</li>
                              </ul>
            </li>
                  
                      <li class="dropdown-submenu">
                                      <a href="project-reports.html"  title="Project Reports">Project Reports</a>
              <ul class="dropdown-menu">
                                  <li>      <a href="apidocs/index.html"  title="JavaDocs">JavaDocs</a>
</li>
                                  <li>      <a href="xref/index.html"  title="Source Xref">Source Xref</a>
</li>
                              </ul>
            </li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Modules <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="../itk-api/index.html"  title="ITK API">ITK API</a>
</li>
                  
                      <li>      <a href="../itk-ri/index.html"  title="ITK Java Reference Implementation">ITK Java Reference Implementation</a>
</li>
                  
                      <li>      <a href="../itk-samples/index.html"  title="ITK Samples project">ITK Samples project</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Reference <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="requirements-cross-ref.html"  title="ITK Requirement traceability">ITK Requirement traceability</a>
</li>
                  
                      <li>      <a href="../itk-api/apidocs/index.html"  title="Javadocs (API only)">Javadocs (API only)</a>
</li>
                  
                      <li>      <a href="apidocs/index.html"  title="Javadocs (API + RI + Samples)">Javadocs (API + RI + Samples)</a>
</li>
                  
                      <li>      <a href="xref/index.html"  title="Java source cross-reference">Java source cross-reference</a>
</li>
                  
                      <li>      <a href="../itk-samples/downloads.html"  title="Downloads">Downloads</a>
</li>
                  
                      <li>      <a href="../itk-samples/index.html"  title="Install Guide">Install Guide</a>
</li>
                  
                      <li>      <a href="docs/ITK Basic Workshop v0.1 - Webex.pdf"  target="_blank" title="ITK Basic Workshop - Webex Slides">ITK Basic Workshop - Webex Slides</a>
</li>
                          </ul>
      </li>
                <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Disclaimer <b class="caret"></b></a>
        <ul class="dropdown-menu">
        
                      <li>      <a href="disclaimer.html"  title="Disclaimer">Disclaimer</a>
</li>
                          </ul>
      </li>
                  </ul>
          
          
                                                              
                               <ul class="nav pull-right">
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">External Links <b class="caret"></b></a>
                <ul class="dropdown-menu">
                      <li>      <a href="http://services.developer.nhs.uk/itk-samples/"  title="ITK RI (Running samples)">ITK RI (Running samples)</a>
</li>
      <li>      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop"  title="CFH ITK home page">CFH ITK home page</a>
</li>
      <li>      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop/fund"  title="ISCF">ISCF</a>
</li>
      <li>      <a href="http://www.uktcregistration.nss.cfh.nhs.uk/trud3/user/guest/group/0/pack/21"  title="ITK @ TRUD">ITK @ TRUD</a>
</li>
      <li>      <a href="http://www.networks.nhs.uk/nhs-networks/interoperability-toolkit-itk"  title="ITK @ NHS Networks">ITK @ NHS Networks</a>
</li>
      <li>      <a href="http://www.linkedin.com/groups/NHS-Interoperability-Toolkit-3831338"  title="ITK @ LinkedIn">ITK @ LinkedIn</a>
</li>
                  </ul>
              </li>
            </ul>
          
                      </div>
          
        </div>
      </div>
    </div>
    
        <div class="container">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                <h2>ITK API and Reference Implementation mini-site</h2>
                </div>
                      </div>
        <div class="pull-right">  </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
            
                
                    
      
                            </ul>
      </div>

      
                
        <div id="bodyColumn" >
                                  
            
 
  
  <div id="container">
    <div id="bodyColumn">
      <div class="section">
        <div class="section"><h2>ADT Query patient (XML)<a name="ADT_Query_patient_XML"></a></h2>
        <ul class="nav nav-tabs tab-control">
		  <li class="active"><a href="#overview">Overview</a></li>
		  <li><a href="#sender">Sender</a></li>
		  <li><a href="#receiver">Receiver</a></li>
		  <li><a href="#request">Request</a></li>
		  <li><a href="#response">Response</a></li>
		</ul>
     </div>
     </div>

<!-- a href="#" id="example" class="btn btn-success" rel="popover">Hover over me! Please Don't Click</a -->


<div class="row-fluid" style="height:325px">
    <div class="span5">
      <p class="tab-title">Black Box View</p>
   
       <div class="clickablemapview">
	       <img src="images/ADT Simple Async - black-box view.jpg" alt="" usemap="#bbviewmap" />
	        <map name="bbviewmap" id="bbviewmap">
		       <area shape="rect" coords="25,35,112,84" alt="" title="Sender" href="#sender" />
		       <area shape="rect" coords="346,35,433,84" alt="" title="Receiver" href="#receiver" />
	       </map>
        </div>    
    </div>
    <div class="span7">
        <div class="tab-content">
  <div class="tab-pane active" id="overview">
        <p class="tab-title">Overview</p>
         <p>In this scenario a client application queries a remote Master Patient Index (MPI) asynchronously using an XML version
         of an ADT HL7v2 message.
         From a business perspective this is typically used by a departmental system to retrieve demographics from the hospital PAS
         </p>
	     <p>The following describes the logic required to invoke the ITK <tt>urn:nhs-itk:services:201005:getPatientDetailsByNHSNumber-v1-0</tt> service.</p>
	     <p></p>
	       <p>From a black-box perspective this asynchronous interaction is still fairly straightforward, though obviously more complicated than the synchronous interactions.
	       The service requestor sends the appropriate ITK request message and receives a synchronous acknowledgement. Any exceptions 
	       encountered in accepting the request will be returned as synchronous SOAP Faults.</p>
	       <p>Sometime later, the query response is returned by the service provider (PAS) asynchronously to a callback handler specified by the service requestor. Any exceptions 
	       encountered in processing the request will be returned as asynchronous SOAP Faults.
	       </p>
  </div>

  <div class="tab-pane" id="sender">
        <p class="tab-title">Sender View</p>
        <p>
        The Sender builds a <tt>SimpleMessage</tt> using a String containing the p/h ADT message. Configuration of the service tells
        the R.I. that this messages requires base64 encoding so the RI performs the encoding and builds the DistributionEnvelope with the appropriate
        tagging.
        </p>
  </div>
  <div class="tab-pane" id="receiver">
        <p class="tab-title">Receiver View</p>
        <p>
            The Receiver consumers the SOAP message. This validates the SOAP headers and then extracts the payload. The SOAP payload is then split further
            into Distribution Envelope and business payload. The Distribution Envelope is validated and extracted into <tt>MessageProperties</tt>.
            The R.I. then looks up the service properties from the configuration and - in this case - as the payload is in base64 form it is decoded before
            being packaged up as a <tt>SimpleMessage</tt> and passed onto the Application Message Handler.
            </p>
  </div>
  <div class="tab-pane" id="request">
      <p class="tab-title">Request Message
      <a href="samples/Q21.xml" target="_blank" type="text/xml">(Get example)</a></p>
		<div class="source">
			<div><pre class="prettyprint">
&lt;soap:Envelope xmlns:itk=&quot;urn:nhs-itk:ns:201005&quot; ... &gt;
 &lt;soap:Header&gt; ... &lt;/soap:Header&gt;
 &lt;soap:Body&gt;
  &lt;itk:DistributionEnvelope ... &gt;
   &lt;itk:header service=&quot;urn:nhs-itk:services:201005:admitPatientPH-v1-0&quot; ...&gt;
    ...
   &lt;/itk:header&gt;
   &lt;itk:payloads count=&quot;1&quot;&gt;
    &lt;itk:payload id=&quot;...&quot;&gt;TVNIfF5+X ... 4MTIzNHwNCg== &lt;/itk:payload&gt;
   &lt;/itk:payloads&gt;
  &lt;/itk:DistributionEnvelope&gt;
 &lt;/soap:Body&gt;
&lt;/soap:Envelope&gt;</pre></div>
		</div>
  </div>
  <div class="tab-pane" id="response">
      <p class="tab-title">Response Message
      <a href="samples/K21.xml" target="_blank" type="text/xml">(Get example)</a></p>
		<div class="source">
			<div><pre class="prettyprint">
&lt;itk:manifest count=&quot;1&quot;&gt;
        &lt;itk:manifestitem base64=&quot;true&quot;
            id=&quot;uuid_6e9306ba-9a09-4479-a719-fcc23234b9ec&quot;
            mimetype=&quot;text/plain&quot; profileid=&quot;ITKv1.0&quot;/&gt;
    &lt;/itk:manifest&gt;
    &lt;itk:senderAddress uri=&quot;urn:nhs-uk:addressing:ods:TESTORGS:ORGA&quot;/&gt;
&lt;/itk:header&gt;
&lt;itk:payloads count=&quot;1&quot;&gt;
   &lt;itk:payload id=&quot;uuid_6e9306ba-9a09-4479-a719-fcc23234b9ec&quot;&gt;TVNIfF5+XCZ8...
    ....HwNCg==&lt;/itk:payload&gt;
&lt;/itk:payloads&gt;</pre></div>
		</div>
      
  </div>
</div>
    </div>
</div>
   <div id="bodyColumn3">
          <div class="section">
               <div class="section"><h2>How it all happens....<a name="How_it_all_happens...."></a></h2>
	        <ul class="nav nav-tabs tab-control">
			  <li class="active"><a href="#step1" class="itk-application">Step 1<br />(Sender App)</a></li>
			  <li><a href="#step2" class="itk-sender">Step 2<br />(Sender)</a></li>
			  <li><a href="#step3" class="itk-sender">Step 3<br />(Sender)</a></li>
			  <li><a href="#step4" class="itk-receiver">Step 4<br />(Receiver)</a></li>
			  <li><a href="#step5" class="itk-application">Step 5<br />(Rcv App)</a></li>
			  <li><a href="#step6" class="itk-receiver">Step 6<br />(Receiver)</a></li>
			  <li><a href="#step7" class="itk-callback">Step 7<br />(Callback)</a></li>
			  <li><a href="#step8" class="itk-application">Step 8<br />(CB App)</a></li>
			</ul>
          </div>
    </div>

       <div class="tab-content">
<div class="row-fluid tab-pane active" id="step1">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-application label-large">Step 1</span>
	       <span class="tab-title">(Sending Application)</span>
	    </p>

		<p>The sending application builds a <tt>SimpleMessage</tt> and populates the business payload with the ADT message.
		The application then sets a number of message properties before creating a message sender and sending the message.</p>
		<p>In this the application uses the sendAsync call of the ITK API because the call is to be asynchronous. Normally this will be
		known at design time, but as the example shows this decision can be made at run-time provided the application is sophisticated
		to handle the two paradigms.</p>
		<p>The full <a href="xref/uk/nhs/interoperability/client/samples/adt/ADTServlet.html#45">source code for the sample ADT Servlet can be seen here</a>.</p>
		
	</div>

	<div class="span7">
		<div class="source">
			<div><pre class="prettyprint">
 // Create the message
 ITKMessage msg = new SimpleMessage();
 msg.setBusinessPayload(docText);
 ...
 // Set the message properties
 mp.setServiceId(&quot;urn:nhs-itk:services:201005:queryPatientDemographics-v1-0&quot;);
 ...
 // Create the sender
 ITKMessageSender sender = new ITKMessageSenderImpl();
 ...
 // Send this message Asynchronously - return is void.
 sender.sendAsync(msg);</pre></div>
		</div>

	</div>

</div>
<div class="row-fluid tab-pane" id="step2">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-sender label-large">Step 2</span>
	       <span class="tab-title">(Sending R.I. - ITK Layer)</span>
	    </p>
		<p>The first layer of the ITK Reference Implementation (R.I.) is the sendAsync method of the ITKMessageSenderImpl.
		This component is responsible for checking service properties, establishing the physical transport route 
		and adding the ITK Distribution Envelope, as described in earlier scenarios.</p>
		<p>For a simple asynchronous message the service configuration is of particular interest.  
		ADT messages can be sent synchronously or asynchronously,
		but in the later case the return endpoint needs to be defined. The R.I. does this through the <tt>directory.properties</tt> 
		configuration file, which manages all configurable aspects of message routing.</p>
		<p>The config on the right is taken from the Samples Project and shows where callback calls are routed to.</p>
		<p>The full <a href="xref/uk/nhs/interoperability/source/ITKMessageSenderImpl.html#93">source code for the ITKMessageSenderImpl can be seen here</a>.</p>
	</div>
	<div class="span7">

		<div class="source">
			<div><pre class="prettyprint">
public void sendAsync(ITKMessage request) throws ITKMessagingException {
 String serviceId = request.getMessageProperties().getServiceId();
 // Get the ITKService from the DirectoryOfService
 ITKService service = dos.getService(serviceId);
 // validate the service configuration is valid for an async call 
 ...
 ITKTransportRoute route = getRoute(request);
 ITKSender sender = getSender(route);
 ITKMessage message = buildMessage(request, route, service);
 sender.sendAysnc(route, message);</pre></div>
		</div>
		<div class="source">
			<div><pre class="prettyprint">
 urn\:nhs-itk\:services\:201005\:queryPatientDemographics-v1-0.urn\:nhs-uk\:addressing\:ods\:TESTORGS\:ADTLOCAL.channelid=ADTLOCAL
 # Configure callback for async calls
 ADTLOCAL.ReplyTo=http://localhost:8080/itk-samples/adt/callback
 ADTLOCAL.ExceptionTo=http://localhost:8080/itk-samples/adt/callback</pre></div>
		</div>

	</div>


</div>
<div class="row-fluid tab-pane" id="step3">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-sender label-large">Step 3</span>
	       <span class="tab-title">(Sending R.I. - WS Layer)</span>
	    </p>
		<p>The next layer of the ITK Reference Implementation (R.I.) is the sendAsync method of the ITKSenderWSImpl.</p>
		<p>This component is responsible for managing the WebServices layer - building the SOAP wrappers, physically sending the message,
		then interpreting the response.</p>
		<p>The sendAsync code tells the SOAP handler (<tt>WSSOAPMessageImpl</tt>) that the message is an Async request which, 
		together with the configuration properties, enables the R.I. to build the correct SOAP Headers.</p>
		<p>The full <a href="xref/uk/nhs/interoperability/transport/WS/ITKSenderWSImpl.html#152">source code for the ITKSenderWSImpl can be seen here</a>.
		</p>
		
	</div>
	<div class="span7">

		<div class="source">
			<div><pre class="prettyprint">
public void sendAysnc(ITKTransportRoute dest, ITKMessage req) ...
 // Add the soap wrappers
 WSSOAPMessageImpl message 
   = new WSSOAPMessageImpl(dest, req, WSSOAPMessageImpl.ASYNCREQ);</pre></div>
		</div>

		<div class="source">
			<div><pre class="prettyprint">
 &lt;soap:Header&gt;
  &lt;wsa:MessageID&gt;D16AF8FB- ... -0A7858587D49&lt;/wsa:MessageID&gt;
  &lt;wsa:Action&gt;urn:nhs ... :queryPatientDemographics-v1-0&lt;/wsa:Action&gt;
  &lt;wsa:To&gt;http://localhost:8080/itk-samples/adt/emulator&lt;/wsa:To&gt;
  &lt;wsa:From&gt; ...  &lt;/wsa:From&gt;
  &lt;wsa:ReplyTo&gt;
      &lt;wsa:Address&gt;http://localhost:8080/itk-samples/adt/callback
      &lt;/wsa:Address&gt;
  &lt;/wsa:ReplyTo&gt;
  &lt;wsa:FaultTo&gt;
      &lt;wsa:Address&gt;http://localhost:8080/itk-samples/adt/callback
      &lt;/wsa:Address&gt;
  &lt;/wsa:FaultTo&gt;
	...
  &lt;/soap:Header&gt;</pre></div>
		</div>

	</div>

</div>

<div class="row-fluid tab-pane" id="step4">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-receiver label-large">Step 4</span>
	       <span class="tab-title">(Receiver R.I.)</span>
	    </p>
		<p>
		The Reference Implementation provides the <tt>AbstractSimpleMessageServlet</tt> as an abstract implementation of an ITK
		receiving application. This is realised by an application provider producing an extension of this class providing concete 
		implementations of the abstract methods.</p>
		<p>This abstract class extracts the incoming transport properties from the SOAP headers and attaches them to the ITKMessage
		which is built to represent the inbound message, providing a mechanism for the reply to parameters to live with the message.</p>
		<p>Importantly the replyTo parameter is used by the R.I. to determine whether to invoke the application handler synchronously or asynchronously.
		</p>
		<p>The full <a href="xref/uk/nhs/interoperability/consumer/AbstractSimpleMessageServlet.html#57">source code for the AbstractSimpleMessageServlet can be seen here</a>.
		</p>
	</div>
	<div class="span7">

		<div class="source">
			<div><pre class="prettyprint">
 // 2) PROCESS THE SOAP HEADERS
 //Extract the transport properties
 itkTransportProperties = ITKTransportPropertiesImpl.buildFromSoap(doc);
 ...
 //Attach the associated transport properties so that they 
 //       are available for asynchronous invocations
 itkMessageProperties.setInboundTransportProperties(itkTransportProperties);
 ...
 //Determine which method to call on application
 if (StringUtils.hasValue(itkTransportProperties.getTransportReplyTo())) { 
	//ReplyTo is present - must want asynchronous response
	this.messageConsumer.onMessage(requestMsg);
 } else {
	//ReplyTo is not present assume synchronous application 
	response = this.messageConsumer.onSyncMessage(requestMsg);
 }</pre></div>
		</div>
	</div>
</div>

<div class="row-fluid tab-pane" id="step5">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-application label-large">Step 5</span>
	       <span class="tab-title">(Receiver Application)</span>
	    </p>
		<p>In the Async ADT Query in the Samples project the <tt>SimpleApplicationEmulator</tt> is used to illustrate this.
		This emulator creates the response message using the message properties from the request, thereby telling the R.I. that 
		this is a response to that message.</p>
		<p>In this scenario the onMessage method of the application handler wass called which provides no response. 
		Once control is received from the handler the R.I. will simply return an HTTP 202 acknowledgement on the open channel.</p>
		<p>The full <a href="xref/uk/nhs/interoperability/consumer/appemulator/SimpleApplicationEmulator.html#79">source code for the SimpleApplicationEmulator can be seen here</a>.
	    </p>
	</div>
	<div class="span7">

		<div class="source">
			<div><pre class="prettyprint">
private ITKMessage turnaroundViaFile(String responseProfileId, 
          ITKMessage request) throws ITKMessagingException {
		
  //Create a response using the message properties from the request
  SimpleMessage msg = new SimpleMessage(request.getMessageProperties(), 
		this.auditIdentity, responseProfileId, true);
  ...
  // Read the response from a pre-defined file 
  String responseString;
  try {
	 responseString = readFile(fileName);
  } catch (IOException e) {
	 ...
  }
  msg.setBusinessPayload(responseString);
  return msg;</pre></div>
		</div>

	</div>


</div>

<div class="row-fluid tab-pane" id="step6">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-receiver label-large">Step 6</span>
	       <span class="tab-title">(Receiver R.I.)</span>
	    </p>
	    <p>The response message is sent through the normal <tt>send</tt> API. 
	    However. because the ITKMessage was built from the incoming message properties (including the ReplyTo), the message already knows the 
	    route back to the callback endpoint and therefore skips the routing lookup. </p>
	    <p>The ITKMessageSenderImpl allows for this pre-determination of route.</p>
		<p>The full <a href="xref/uk/nhs/interoperability/source/ITKMessageSenderImpl.html#93">source code for the ITKMessageSenderImpl can be seen here</a>.</p>
	</div>
	<div class="span7">

		<div class="source">
			<div><pre class="prettyprint">
private ITKTransportRoute getRoute(ITKMessage request) ...

  String serviceId = request.getMessageProperties().getServiceId();

  // Has the transport route already been resolved? 
  ITKTransportRoute route = request.getPreresolvedRoute();
  ...
  // If the route has not been pre-resolved look it up
  if (route == null) {
    route = dos.resolveDestination(serviceId, toAddress);
  } else {
    Logger.debug(&quot;Pre-resolved transport route on object &quot; ...
  }</pre></div>
		</div>

	</div>

</div>

<div class="row-fluid tab-pane" id="step7">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-callback label-large">Step 7</span>
	       <span class="tab-title">(Callback R.I.)</span>
	    </p>
		<p>
		The Reference Implementation provides the <tt>AbstractCallbackListenerServlet</tt> as an abstract implementation of an ITK
		callback application. This is realised by an application provider producing an extension of this class which acts as a factory 
		providing an instance of the callback handler <tt>ITKCallbackHandler</tt>.</p>
		<p>The abstract class extracts the incoming transport properties from the SOAP headers and attaches them to the ITKMessage
		which is built to represent the inbound message. The message is passed to the <tt>processITKMessage</tt> layer which hands
		off processing to the appropriate application handler.</p>
		<p>The full <a href="xref/uk/nhs/interoperability/consumer/AbstractCallbackListenerServlet.html#56">source code for the AbstractCallbackListenerServlet can be seen here</a>.
	    </p>
	</div>
	<div class="span7">

		<div class="source">
			<div><pre class="prettyprint">
public interface ITKCallbackHandler {

	public abstract void onMessage(ITKMessage response);

	public abstract void onAck(ITKAckDetails ack);

	public abstract void onNack(ITKAckDetails ack);

}</pre></div>
		</div>

	</div>


</div>

<div class="row-fluid tab-pane" id="step8">
	<div class="span5"><p></p>
	    <p><span class="label itk-label-application label-large">Step 8</span>
	       <span class="tab-title">(Callback Application)</span>
	    </p>
		<p>Finally, the application call handler processes the message as per the local requirements of the system</p> 
		<p>The sample callback hander simply prints a message.
		</p>
	</div>
	<div class="span7">

		<div class="source">
			<div><pre class="prettyprint">
public class SimpleMessageCallbackHandler 
  extends AbstractCallbackListenerServlet 
  implements ITKCallbackHandler {

  public void onMessage(ITKMessage request) {
    Logger.trace(&quot;This is my example callback handler:onMessage()&quot;);
  }</pre></div>
		</div>

	</div>


</div>


</div>

</div>


                  </div>
          </div>

    <hr/>

    <footer>
            <div class="container">
              <div class="row span12">All content is available under the <a href="http://www.nationalarchives.gov.uk/doc/open-government-licence/" title="Open Government Licence">Open Government Licence</a>, except where otherwise stated<br/>
                                  All example source code is available under <a href="http://www.apache.org/licenses/LICENSE-2.0.html" title="Apache 2.0 License">Apache 2.0</a>, except where otherwise stated      
                    
                  <li id="publishDate" class="pull-right">Last Published: 2013-03-06</li> 
              <li id="projectVersion" class="pull-right">Version: 0.1-SNAPSHOT</li>
            </div>

        
                <p id="poweredBy" class="pull-right">
                                                                                                                      <a href="http://www.connectingforhealth.nhs.uk/systemsandservices/interop" title="ITK" class="builtBy">
        <img class="builtBy"  alt="ITK" src="images/itk-logo-2.png"    />
      </a>
                  </p>
        
                </div>
    </footer>
  </body>
</html>
